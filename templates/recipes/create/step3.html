{% extends "layout.html" %}

{% block content %}
<div class="container py-5 animate-fade-in">
    <div class="row justify-content-center">
        <div class="col-12">
            <!-- Navigation -->
            <div class="mb-4">
                <a href="/recipes/create/step2" class="text-secondary text-decoration-none body-medium transition-fast" style="display: inline-flex; align-items: center; gap: var(--space-2);">
                    <span>←</span>
                    <span>Назад</span>
                </a>
            </div>

            <!-- Step Indicator -->
            <div class="step-indicator body-small text-center mb-3" style="color: var(--text-secondary);">
                Шаг 3 из 3
            </div>

            <!-- Main Headline -->
            <div class="text-center mb-5">
                <h1 class="display-medium mb-3" style="color: var(--text-primary); font-weight: var(--font-weight-semibold);">
                    Задай ограничения (по желанию)
                </h1>
                <p class="body-large" style="color: var(--text-secondary);">
                    Калории обязательны. Остальное можно пропустить.
                </p>
            </div>

            <!-- Content Section -->
            <div class="content-section card animate-scale-in mb-4">
                <div class="card-body p-4">
                    <!-- Calories Section -->
                    <div class="calories-section text-center mb-4">
                        <div class="calories-input-container position-relative d-inline-block">
                            <input type="number" id="target_calories" name="target_calories"
                                   class="calories-input form-control form-control-lg text-center"
                                   style="background: var(--surface); border: 2px solid var(--secondary); color: var(--text-primary); font-size: 2rem; font-weight: var(--font-weight-semibold); padding: 1rem 3rem 1rem 1rem; width: 200px; border-radius: var(--radius-lg);"
                                   placeholder="500" min="50" max="5000" required>
                            <span class="calories-unit position-absolute" style="right: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-secondary); font-weight: var(--font-weight-medium);">ккал</span>
                        </div>
                    </div>

                    <!-- Cooking Tags Section -->
                    <h3 class="section-title headline-medium mb-4" style="color: var(--text-primary); font-weight: var(--font-weight-semibold);">
                        Как готовить?
                    </h3>
                    <div class="cooking-tags d-flex flex-wrap gap-3 mb-4">
                        <button class="tag-chip btn rounded-pill px-3 py-2" style="background: var(--surface-hover); color: var(--text-primary); border: 1px solid var(--border);" data-tag="варить">варить</button>
                        <button class="tag-chip btn rounded-pill px-3 py-2" style="background: var(--surface-hover); color: var(--text-primary); border: 1px solid var(--border);" data-tag="жарить">жарить</button>
                        <button class="tag-chip btn rounded-pill px-3 py-2" style="background: var(--surface-hover); color: var(--text-primary); border: 1px solid var(--border);" data-tag="запекать">запекать</button>
                        <button class="tag-chip btn rounded-pill px-3 py-2" style="background: var(--surface-hover); color: var(--text-primary); border: 1px solid var(--border);" data-tag="только сырое">только сырое</button>
                        <button class="tag-chip btn rounded-pill px-3 py-2" style="background: var(--surface-hover); color: var(--text-primary); border: 1px solid var(--border);" data-tag="просто смешать">просто смешать</button>
                    </div>

                    <!-- Advanced Options Toggle -->
                    <button class="advanced-toggle btn w-100 text-start p-3 mb-3" style="background: var(--surface-hover); color: var(--text-primary); border: 1px solid var(--border); border-radius: var(--radius-lg);" id="advancedToggle">
                        <i class="bi bi-chevron-down me-2"></i>
                        Хочу точнее настроить
                    </button>

                    <!-- Advanced Options Content -->
                    <div class="advanced-content" id="advancedContent" style="display: none; margin-top: var(--space-4); padding-top: var(--space-4); border-top: 1px solid var(--border-light);">
                        <div class="advanced-grid row g-3">
                            <div class="col-md-6">
                                <div class="input-group-advanced d-flex align-items-center">
                                    <input type="number" id="target_protein" name="target_protein"
                                           class="input-advanced form-control" style="background: var(--surface); border: 1px solid var(--border); color: var(--text-primary);" placeholder="Белки" min="0" max="500" step="0.5">
                                    <span class="unit-text ms-2 body-small" style="color: var(--text-secondary); min-width: 20px;">г</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group-advanced d-flex align-items-center">
                                    <input type="number" id="target_fat" name="target_fat"
                                           class="input-advanced form-control" style="background: var(--surface); border: 1px solid var(--border); color: var(--text-primary);" placeholder="Жиры" min="0" max="500" step="0.5">
                                    <span class="unit-text ms-2 body-small" style="color: var(--text-secondary); min-width: 20px;">г</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group-advanced d-flex align-items-center">
                                    <input type="number" id="target_carbs" name="target_carbs"
                                           class="input-advanced form-control" style="background: var(--surface); border: 1px solid var(--border); color: var(--text-primary);" placeholder="Углеводы" min="0" max="1000" step="0.5">
                                    <span class="unit-text ms-2 body-small" style="color: var(--text-secondary); min-width: 20px;">г</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group-advanced d-flex align-items-center">
                                    <input type="number" id="greens_weight" name="greens_weight"
                                           class="input-advanced form-control" style="background: var(--surface); border: 1px solid var(--border); color: var(--text-primary);" placeholder="Растительность" min="0" max="1000" step="10">
                                    <span class="unit-text ms-2 body-small" style="color: var(--text-secondary); min-width: 20px;">г</span>
                                </div>
                            </div>
                        </div>

                        <!-- Preview Section -->
                        <div class="preview-section card mt-4" id="previewSection" style="display: none; background: var(--surface-hover); border: 1px solid var(--border-light);">
                            <div class="card-body p-3">
                                <h4 class="preview-title headline-small mb-3 text-center" style="color: var(--text-primary); font-weight: var(--font-weight-semibold);">
                                    Предварительный расчёт
                                </h4>
                                <div class="preview-grid row text-center g-2">
                                    <div class="col-3">
                                        <div class="preview-item p-2">
                                            <div class="preview-value body-large fw-bold" style="color: var(--secondary);" id="preview-calories">-</div>
                                            <div class="preview-label body-small" style="color: var(--text-secondary);">ккал</div>
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <div class="preview-item p-2">
                                            <div class="preview-value body-large fw-bold" style="color: var(--primary);" id="preview-protein">-</div>
                                            <div class="preview-label body-small" style="color: var(--text-secondary);">белки</div>
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <div class="preview-item p-2">
                                            <div class="preview-value body-large fw-bold" style="color: var(--warning);" id="preview-fat">-</div>
                                            <div class="preview-label body-small" style="color: var(--text-secondary);">жиры</div>
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <div class="preview-item p-2">
                                            <div class="preview-value body-large fw-bold" style="color: var(--info);" id="preview-carbs">-</div>
                                            <div class="preview-label body-small" style="color: var(--text-secondary);">углеводы</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CTA Section -->
            <div class="cta-section text-center">
                <button class="primary-btn btn btn-primary btn-lg px-5 py-3" id="createBtn" disabled>
                    <i class="bi bi-magic me-2"></i>Создать рецепт
                </button>
            </div>
        </div>
    </div>
</div>

<form id="recipeForm" method="post" action="/recipes/create/step3" style="display: none;" accept-charset="UTF-8">
    <input type="hidden" id="form_target_calories" name="target_calories">
    <input type="hidden" id="form_target_protein" name="target_protein">
    <input type="hidden" id="form_target_fat" name="target_fat">
    <input type="hidden" id="form_target_carbs" name="target_carbs">
    <input type="hidden" id="form_greens_weight" name="greens_weight">
    <input type="hidden" id="form_cooking_tags" name="cooking_tags">
</form>
{% endblock %}

{% block extra_css %}
<style>
.content-section .card {
    border: 1px solid var(--border);
    background: var(--surface);
}

.calories-input:focus {
    border-color: var(--secondary-dark) !important;
    box-shadow: 0 0 0 3px rgba(87, 108, 237, 0.1) !important;
}

.tag-chip:hover {
    background: var(--surface) !important;
    border-color: var(--border-light) !important;
}

.tag-chip.selected {
    background: var(--secondary) !important;
    border-color: var(--secondary) !important;
    color: white !important;
}

.advanced-toggle:hover {
    background: var(--surface) !important;
    border-color: var(--border-light) !important;
}

.advanced-toggle.active {
    background: var(--surface) !important;
    border-color: var(--border-light) !important;
}

.advanced-content.show {
    display: block !important;
}

.input-advanced:focus {
    border-color: var(--secondary) !important;
    box-shadow: 0 0 0 2px rgba(87, 108, 237, 0.1) !important;
}

.preview-section.show {
    display: block !important;
}

.primary-btn:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.primary-btn:disabled {
    background: var(--text-disabled) !important;
    cursor: not-allowed;
    transform: none;
}

@media (max-width: 767.98px) {
    .calories-input {
        width: 150px !important;
        font-size: 1.5rem !important;
    }

    .preview-grid .col-3 {
        flex: 0 0 auto;
        width: 25%;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Cooking tags selection
    const tagChips = document.querySelectorAll('.tag-chip');
    const selectedTags = new Set();

    tagChips.forEach(chip => {
        chip.addEventListener('click', function() {
            const tag = this.dataset.tag;
            if (selectedTags.has(tag)) {
                selectedTags.delete(tag);
                this.classList.remove('selected');
            } else {
                selectedTags.add(tag);
                this.classList.add('selected');
            }
            updateCreateButton();
        });
    });

    // Advanced options toggle
    const advancedToggle = document.getElementById('advancedToggle');
    const advancedContent = document.getElementById('advancedContent');

    advancedToggle.addEventListener('click', function() {
        const isActive = advancedContent.classList.contains('show');
        if (isActive) {
            advancedContent.classList.remove('show');
            this.innerHTML = '<i class="bi bi-chevron-down me-2"></i>Хочу точнее настроить';
            this.classList.remove('active');
        } else {
            advancedContent.classList.add('show');
            this.innerHTML = '<i class="bi bi-chevron-up me-2"></i>Свернуть настройки';
            this.classList.add('active');
        }
    });

    // Calories input validation and button enable
    const caloriesInput = document.getElementById('target_calories');
    const createBtn = document.getElementById('createBtn');

    caloriesInput.addEventListener('input', function() {
        updateCreateButton();
    });

    function updateCreateButton() {
        const hasCalories = caloriesInput.value.trim() !== '';
        createBtn.disabled = !hasCalories;
    }

    // Preview update for advanced options
    const advancedInputs = document.querySelectorAll('.input-advanced');
    const previewSection = document.getElementById('previewSection');

    advancedInputs.forEach(input => {
        input.addEventListener('input', updatePreview);
    });

    function updatePreview() {
        const calories = parseFloat(caloriesInput.value) || 0;
        const protein = parseFloat(document.getElementById('target_protein').value) || 0;
        const fat = parseFloat(document.getElementById('target_fat').value) || 0;
        const carbs = parseFloat(document.getElementById('target_carbs').value) || 0;

        // Show preview only if any advanced values are entered
        const hasAdvancedValues = protein > 0 || fat > 0 || carbs > 0;
        if (hasAdvancedValues) {
            previewSection.classList.add('show');
            document.getElementById('preview-calories').textContent = calories;
            document.getElementById('preview-protein').textContent = protein + 'г';
            document.getElementById('preview-fat').textContent = fat + 'г';
            document.getElementById('preview-carbs').textContent = carbs + 'г';
        } else {
            previewSection.classList.remove('show');
        }
    }

    // Form submission
    createBtn.addEventListener('click', function() {
        // Set form values
        document.getElementById('form_target_calories').value = caloriesInput.value;
        document.getElementById('form_target_protein').value = document.getElementById('target_protein').value || '';
        document.getElementById('form_target_fat').value = document.getElementById('target_fat').value || '';
        document.getElementById('form_target_carbs').value = document.getElementById('target_carbs').value || '';
        document.getElementById('form_greens_weight').value = document.getElementById('greens_weight').value || '';
        document.getElementById('form_cooking_tags').value = Array.from(selectedTags).join(',');

        // Submit form
        document.getElementById('recipeForm').submit();
    });

    // Initialize
    updateCreateButton();
    updatePreview();
});
</script>
{% endblock %}




