{% extends "layout.html" %}

{% block content %}
<div class="container py-5 animate-fade-in">
    <div class="row justify-content-center">
        <div class="col-12 text-center">
            <!-- Navigation -->
            <div class="mb-4">
                <a href="/" class="text-secondary text-decoration-none body-medium transition-fast" style="display: inline-flex; align-items: center; gap: var(--space-2);">
                    <span>←</span>
                    <span>На главную</span>
                </a>
            </div>

            <!-- Step Indicator -->
            <div class="step-indicator body-small mb-4" style="color: var(--text-secondary);">
                Шаг 1 из 3
            </div>

            <!-- Upload Container -->
            <div class="upload-container card animate-scale-in" style="max-width: 500px; margin: 0 auto; border: 2px dashed var(--secondary); background: var(--surface); cursor: pointer; transition: all var(--duration-normal) var(--easing-standard);">
                <div class="card-body p-5 text-center">
                    <div class="upload-icon mb-4">
                        <i class="bi bi-camera" style="font-size: 4rem; color: var(--secondary);"></i>
                    </div>
                    <div class="upload-text headline-medium mb-3" style="color: var(--text-primary);">
                        Перетащи фото сюда
                    </div>
                    <div class="upload-subtext body-large" style="color: var(--text-secondary);">
                        или нажми для загрузки
                    </div>
                </div>
            </div>

            {% if error_message %}
            <div class="error-message alert alert-error animate-fade-in mt-4" style="max-width: 500px; margin: 0 auto;">
                <i class="bi bi-exclamation-triangle-fill"></i> {{ error_message }}
            </div>
            {% endif %}

            <!-- Progress Container -->
            <div class="progress-container mt-4" id="progressContainer" style="max-width: 500px; margin: 0 auto; display: none;">
                <div class="progress-bar-wrapper card shadow-md" style="border: 1px solid var(--secondary); background: var(--surface); position: relative; overflow: visible;">
                    <div class="progress-bar card-body p-3" id="progressBar" style="width: 0%; background: var(--secondary); height: 60px; border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; color: white; font-size: var(--text-label-large); font-weight: var(--font-weight-medium); min-width: 80px; position: relative; overflow: visible; transition: width 0.5s ease-out;">
                        <span class="progress-percent-text" id="progressPercent">0%</span>
                        <div class="progress-donut" id="progressDonut" style="position: absolute; left: 0%; top: 50%; transform: translate(-50%, -50%); width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; z-index: 10; filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.2)); transition: left 0.3s ease-out; display: none;">
                            <img src="/static/images/donut.png" alt="Donut" id="donutImage" style="width: 100%; height: 100%; object-fit: contain; animation: donutRoll 2.4s linear infinite;">
                        </div>
                    </div>
                </div>
                <div class="progress-text body-medium mt-3" id="progressText" style="color: var(--text-secondary);">
                    Загрузка фотографии...
                </div>
            </div>

            <form id="uploadForm" method="post" action="/recipes/create/step1" enctype="multipart/form-data" style="display: none;">
                <input type="file" id="photo" name="photo" class="file-input" accept="image/*" required>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.upload-container:hover {
    border-color: var(--secondary-dark);
    background: var(--surface-hover);
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

@keyframes donutRoll {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.step-indicator {
    font-size: var(--text-label-small);
    color: var(--text-secondary);
    margin-bottom: var(--space-6);
}

.upload-icon {
    margin-bottom: var(--space-6);
}

.upload-text {
    margin-bottom: var(--space-3);
}

.upload-subtext {
    margin-bottom: 0;
}

.progress-container {
    margin-top: var(--space-6);
}

.progress-bar-wrapper {
    position: relative;
    overflow: visible;
}

.progress-donut {
    display: none;
}

.progress-donut.show {
    display: flex;
}

.progress-text {
    margin-top: var(--space-3);
    text-align: center;
}

.error-message {
    margin-top: var(--space-6);
}

.file-input {
    display: none;
}
</style>
{% endblock %}

    <div class="step-indicator">Шаг 1 из 3</div>

    <div class="upload-container" onclick="document.getElementById('photo').click()">
        <div class="upload-icon">
            <i class="bi bi-camera"></i>
        </div>
        <div class="upload-text">Перетащи фото сюда</div>
        <div class="upload-subtext">или нажми для загрузки</div>
    </div>

    {% if error_message %}
    <div class="error-message">
        <i class="bi bi-exclamation-triangle-fill"></i> {{ error_message }}
    </div>
    {% endif %}

    <div class="progress-container" id="progressContainer">
        <div class="progress-bar-wrapper">
            <div class="progress-bar" id="progressBar" style="width: 0%">
                <span class="progress-percent-text" id="progressPercent">0%</span>
                <div class="progress-donut" id="progressDonut" style="display: none;">
                    <img src="/static/images/donut.png" alt="Donut" id="donutImage">
                </div>
            </div>
        </div>
        <div class="progress-text" id="progressText">Загрузка фотографии...</div>
    </div>

    <form id="uploadForm" method="post" action="/recipes/create/step1" enctype="multipart/form-data" style="display: none;">
        <input type="file" id="photo" name="photo" class="file-input" accept="image/*" required>
    </form>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Обработчик клика на upload container
    const uploadContainer = document.querySelector('.upload-container');
    uploadContainer.addEventListener('click', function() {
        document.getElementById('photo').click();
    });

    // Обработчик выбора файла
    document.getElementById('photo').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // Проверка размера файла (10MB)
            if (file.size > 10 * 1024 * 1024) {
                showError('Файл слишком большой! Максимальный размер: 10 MB');
                return;
            }

            // Проверка типа файла
            if (!file.type.startsWith('image/')) {
                showError('Пожалуйста, выберите изображение!');
                return;
            }

            // Загрузка с отслеживанием прогресса
            uploadFileWithProgress(file);
        }
    });

    function uploadFileWithProgress(file) {
        const formData = new FormData();
        formData.append('photo', file);

        const xhr = new XMLHttpRequest();
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressPercent = document.getElementById('progressPercent');
        const progressText = document.getElementById('progressText');

        // Показываем индикатор прогресса
        progressContainer.style.display = 'block';
        progressBar.style.width = '0%';
        progressPercent.textContent = '0%';
        progressText.textContent = 'Загрузка фотографии...';

        // Показываем пончик и сбрасываем позицию
        const donut = document.getElementById('progressDonut');
        donut.classList.add('show');
        donut.style.left = '0%';

        // Отслеживание прогресса загрузки
        let lastPercent = 0;
        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable && e.total > 0) {
                const percentComplete = Math.round((e.loaded / e.total) * 100);

                // Обновляем прогресс только если он увеличился
                if (percentComplete > lastPercent) {
                    progressBar.style.width = percentComplete + '%';
                    progressPercent.textContent = percentComplete + '%';
                    donut.style.left = percentComplete + '%';

                    lastPercent = percentComplete;

                    if (percentComplete < 100) {
                        progressText.textContent = `Загрузка: ${percentComplete}%`;
                    } else {
                        progressText.textContent = 'Обработка фотографии...';
                    }
                }
            }
        });

        // Обработка завершения загрузки
        xhr.addEventListener('load', function() {
            if (xhr.status === 200) {
                progressBar.style.width = '100%';
                progressPercent.textContent = '100%';
                progressText.textContent = 'Загрузка завершена!';
                donut.style.left = '100%';

                setTimeout(function() {
                    window.location.href = '/recipes/create/step2';
                }, 500);
            } else if (xhr.status >= 400) {
                let errorMessage = 'Ошибка при загрузке файла. Попробуйте еще раз.';
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (response.detail) {
                        errorMessage = response.detail;
                    }
                } catch (e) {
                    // ignore
                }
                showError(errorMessage);
                hideProgress();
            }
        });

        // Обработка ошибок сети
        xhr.addEventListener('error', function() {
            showError('Ошибка соединения. Проверьте интернет-соединение.');
            hideProgress();
        });

        xhr.addEventListener('abort', function() {
            hideProgress();
        });

        // Отправка запроса
        xhr.open('POST', '/recipes/create/step1');
        xhr.send(formData);
    }

    function hideProgress() {
        const progressContainer = document.getElementById('progressContainer');
        progressContainer.style.display = 'none';
        document.getElementById('photo').value = '';

        const donut = document.getElementById('progressDonut');
        donut.classList.remove('show');
    }

    function showError(message) {
        const existingError = document.querySelector('.error-message');
        if (existingError) {
            existingError.remove();
        }

        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-error animate-fade-in mt-4';
        errorDiv.style.cssText = 'max-width: 500px; margin: 0 auto;';
        errorDiv.innerHTML = '<i class="bi bi-exclamation-triangle-fill"></i> ' + message;

        const container = document.querySelector('.col-12');
        const uploadContainer = document.querySelector('.upload-container').parentNode;
        container.insertBefore(errorDiv, uploadContainer.nextSibling);

        document.getElementById('photo').value = '';
        hideProgress();
    }

    // Drag and drop functionality
    uploadContainer.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.style.borderColor = 'var(--secondary-dark)';
        this.style.background = 'var(--surface-hover)';
        this.style.transform = 'translateY(-2px)';
    });

    uploadContainer.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.style.borderColor = 'var(--secondary)';
        this.style.background = 'var(--surface)';
        this.style.transform = 'translateY(0)';
    });

    uploadContainer.addEventListener('drop', function(e) {
        e.preventDefault();
        this.style.borderColor = 'var(--secondary)';
        this.style.background = 'var(--surface)';
        this.style.transform = 'translateY(0)';

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            const file = files[0];
            if (file.type.startsWith('image/')) {
                const dt = new DataTransfer();
                dt.items.add(file);
                document.getElementById('photo').files = dt.files;

                const event = new Event('change', { bubbles: true });
                document.getElementById('photo').dispatchEvent(event);
            } else {
                showError('Пожалуйста, выберите изображение!');
            }
        }
    });
});
</script>
{% endblock %}




