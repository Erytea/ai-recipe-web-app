{% extends "layout.html" %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <!-- Recipe Header -->
            <div class="card shadow mb-4">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h1 class="h2 mb-2">{{ recipe_data.recipe_title }}</h1>
                            <p class="text-muted mb-0">
                                <i class="bi bi-calendar"></i>
                                Создан {{ recipe.created_at.strftime('%d.%m.%Y в %H:%M') }}
                            </p>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-success fs-6 px-3 py-2">
                                <i class="bi bi-check-circle-fill"></i> Готово
                            </span>
                        </div>
                    </div>

                    <!-- Nutrition Facts -->
                    <div class="row text-center mb-4">
                        <div class="col-3">
                            <div class="p-3 bg-danger bg-opacity-10 rounded">
                                <div class="h4 text-danger mb-1">{{ recipe_data.calculated_nutrition.calories }}</div>
                                <small class="text-muted">ккал</small>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="p-3 bg-primary bg-opacity-10 rounded">
                                <div class="h4 text-primary mb-1">{{ recipe_data.calculated_nutrition.protein_g }}г</div>
                                <small class="text-muted">белки</small>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="p-3 bg-warning bg-opacity-10 rounded">
                                <div class="h4 text-warning mb-1">{{ recipe_data.calculated_nutrition.fat_g }}г</div>
                                <small class="text-muted">жиры</small>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="p-3 bg-info bg-opacity-10 rounded">
                                <div class="h4 text-info mb-1">{{ recipe_data.calculated_nutrition.carbs_g }}г</div>
                                <small class="text-muted">углеводы</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-5">
                    <!-- Ingredients -->
                    <div class="card shadow mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-basket"></i> Ингредиенты
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Progress bar for ingredients -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-muted">Ингредиенты готовы</small>
                                    <small class="text-muted" id="ingredients-progress">0/{{ recipe_data.ingredients_with_weights|length }}</small>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: 0%" id="ingredients-bar"></div>
                                </div>
                            </div>

                            <div class="ingredient-list">
                                {% for ingredient in recipe_data.ingredients_with_weights %}
                                <div class="ingredient-item d-flex justify-content-between align-items-center py-2 border-bottom">
                                    <div class="d-flex align-items-center flex-grow-1">
                                        <input type="checkbox" class="ingredient-checkbox me-3"
                                               id="ingredient-{{ loop.index }}"
                                               onchange="updateProgress()">
                                        <label for="ingredient-{{ loop.index }}" class="mb-0 cursor-pointer flex-grow-1">
                                            {{ ingredient.name }}
                                        </label>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <input type="number" class="form-control form-control-sm text-end"
                                               value="{{ ingredient.weight_g }}" min="1" max="9999"
                                               style="width: 70px;" onchange="updateTotalNutrition()">
                                        <span class="text-muted">г</span>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>

                            <div class="mt-3 pt-3 border-top">
                                <button class="btn btn-outline-primary btn-sm me-2" onclick="selectAllIngredients()">
                                    <i class="bi bi-check-all"></i> Выбрать все
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="clearAllIngredients()">
                                    <i class="bi bi-x"></i> Снять все
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Original Photo -->
                    {% if recipe.photo_file_id %}
                    <div class="card shadow">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-camera"></i> Исходное фото
                            </h6>
                        </div>
                        <div class="card-body p-3">
                            <img src="/static/{{ recipe.photo_file_id }}" alt="Original photo"
                                 class="img-fluid rounded shadow-sm">
                        </div>
                    </div>
                    {% endif %}
                </div>

                <div class="col-md-7">
                    <!-- Cooking Steps -->
                    <div class="card shadow">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-list-ol"></i> Приготовление
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Cooking Progress -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-muted">Прогресс приготовления</small>
                                    <small class="text-muted" id="cooking-progress">0/{{ recipe_data.cooking_steps|length }}</small>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-warning" role="progressbar" style="width: 0%" id="cooking-bar"></div>
                                </div>
                            </div>

                            <div class="cooking-steps">
                                {% for step in recipe_data.cooking_steps %}
                                <div class="cooking-step mb-4 p-3 rounded" style="background: #f8f9fa; border-left: 4px solid var(--primary-orange);">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div class="d-flex align-items-center">
                                            <input type="checkbox" class="cooking-checkbox me-3"
                                                   id="step-{{ loop.index }}"
                                                   onchange="updateCookingProgress()">
                                            <span class="badge bg-primary me-2">{{ loop.index }}</span>
                                            <h6 class="mb-0">Шаг {{ loop.index }}</h6>
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary timer-btn"
                                                onclick="startTimer(this, {{ loop.index }}, 300)"
                                                id="timer-{{ loop.index }}">
                                            <i class="bi bi-stopwatch"></i> 5:00
                                        </button>
                                    </div>
                                    <p class="mb-2">{{ step }}</p>
                                    <div class="timer-display d-none" id="timer-display-{{ loop.index }}">
                                        <div class="progress mt-2" style="height: 6px;">
                                            <div class="progress-bar bg-success timer-progress" id="timer-bar-{{ loop.index }}"></div>
                                        </div>
                                        <div class="d-flex justify-content-between mt-1">
                                            <small class="timer-text text-muted" id="timer-text-{{ loop.index }}">Осталось: 5:00</small>
                                            <button class="btn btn-sm btn-outline-danger" onclick="stopTimer({{ loop.index }})">
                                                <i class="bi bi-stop-fill"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="card shadow mt-4">
                <div class="card-body text-center">
                    <h5 class="mb-3">Что дальше?</h5>
                    <div class="d-flex gap-2 justify-content-center flex-wrap">
                        <a href="/recipes/create" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> Создать новый рецепт
                        </a>
                        <a href="/meal-plans/create" class="btn btn-success">
                            <i class="bi bi-calendar-plus"></i> Создать план питания
                        </a>
                        <a href="/recipes" class="btn btn-outline-primary">
                            <i class="bi bi-list"></i> Мои рецепты
                        </a>
                        <button onclick="window.print()" class="btn btn-outline-secondary">
                            <i class="bi bi-printer"></i> Распечатать
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
@media print {
    .navbar, .card-header, .btn, footer { display: none !important; }
    .container { max-width: none !important; margin: 0 !important; }
    .card { border: none !important; box-shadow: none !important; }
    .ingredient-checkbox, .cooking-checkbox, .timer-btn { display: none !important; }
}

.ingredient-item:hover {
    background-color: rgba(255, 107, 53, 0.05);
    border-radius: 8px;
    transition: all 0.2s ease;
}

.cooking-step.completed {
    background: linear-gradient(135deg, #d4edda 0%, #f8f9fa 100%);
    border-left-color: #28a745;
}

.cursor-pointer {
    cursor: pointer;
}

.timer-active {
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}
</style>

{% block scripts %}
<script>
// Ingredient checklist functionality
function updateProgress() {
    const checkboxes = document.querySelectorAll('.ingredient-checkbox');
    const checked = document.querySelectorAll('.ingredient-checkbox:checked');
    const progress = (checked.length / checkboxes.length) * 100;

    document.getElementById('ingredients-bar').style.width = progress + '%';
    document.getElementById('ingredients-progress').textContent = checked.length + '/' + checkboxes.length;

    // Add visual feedback
    checked.forEach(cb => {
        cb.closest('.ingredient-item').style.textDecoration = 'line-through';
        cb.closest('.ingredient-item').style.opacity = '0.7';
    });

    document.querySelectorAll('.ingredient-checkbox:not(:checked)').forEach(cb => {
        cb.closest('.ingredient-item').style.textDecoration = 'none';
        cb.closest('.ingredient-item').style.opacity = '1';
    });
}

function selectAllIngredients() {
    document.querySelectorAll('.ingredient-checkbox').forEach(cb => cb.checked = true);
    updateProgress();
}

function clearAllIngredients() {
    document.querySelectorAll('.ingredient-checkbox').forEach(cb => cb.checked = false);
    updateProgress();
}

// Cooking steps functionality
function updateCookingProgress() {
    const checkboxes = document.querySelectorAll('.cooking-checkbox');
    const checked = document.querySelectorAll('.cooking-checkbox:checked');
    const progress = (checked.length / checkboxes.length) * 100;

    document.getElementById('cooking-bar').style.width = progress + '%';
    document.getElementById('cooking-progress').textContent = checked.length + '/' + checkboxes.length;

    // Mark steps as completed
    checked.forEach(cb => {
        cb.closest('.cooking-step').classList.add('completed');
    });

    document.querySelectorAll('.cooking-checkbox:not(:checked)').forEach(cb => {
        cb.closest('.cooking-step').classList.remove('completed');
    });
}

// Timer functionality
const timers = {};

function startTimer(button, stepId, duration) {
    const display = document.getElementById(`timer-display-${stepId}`);
    const progressBar = document.getElementById(`timer-bar-${stepId}`);
    const timerText = document.getElementById(`timer-text-${stepId}`);

    display.classList.remove('d-none');
    button.classList.add('timer-active');

    let timeLeft = duration;
    timers[stepId] = {
        interval: setInterval(() => {
            timeLeft--;
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            button.innerHTML = `<i class="bi bi-stopwatch"></i> ${timeString}`;
            timerText.textContent = `Осталось: ${timeString}`;

            const progress = ((duration - timeLeft) / duration) * 100;
            progressBar.style.width = progress + '%';

            if (timeLeft <= 0) {
                stopTimer(stepId);
                // Show notification
                showNotification(`Шаг ${stepId} готов!`, 'success');
                button.innerHTML = '<i class="bi bi-check-circle-fill"></i> Готово';
                button.classList.remove('timer-active');
                button.classList.add('btn-success');
            }
        }, 1000),
        button: button
    };
}

function stopTimer(stepId) {
    if (timers[stepId]) {
        clearInterval(timers[stepId].interval);
        const display = document.getElementById(`timer-display-${stepId}`);
        display.classList.add('d-none');
        timers[stepId].button.innerHTML = '<i class="bi bi-stopwatch"></i> Таймер';
        timers[stepId].button.classList.remove('timer-active', 'btn-success');
        delete timers[stepId];
    }
}

function updateTotalNutrition() {
    // Recalculate nutrition based on modified ingredient weights
    // This would require server-side calculation, so we'll show a visual indicator
    const modifiedInputs = document.querySelectorAll('input[type="number"]:not([value=""])');
    if (modifiedInputs.length > 0) {
        showNotification('Питательная ценность обновлена', 'info');
    }
}

function showNotification(message, type = 'info') {
    const colors = {
        success: '#4CAF50',
        error: '#F44336',
        warning: '#FF9800',
        info: '#2196F3'
    };

    const notification = document.createElement('div');
    notification.innerHTML = `
        <div style="
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${colors[type]};
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 9999;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            animation: slideInRight 0.3s ease;
        ">
            <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'info-circle'} me-2"></i>
            ${message}
        </div>
    `;

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updateProgress();
    updateCookingProgress();
});
</script>
{% endblock %}
{% endblock %}


