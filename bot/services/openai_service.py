import base64
import json
import logging
from typing import Dict, List, Optional
from openai import AsyncOpenAI

from bot.core.config import settings
from bot.services.nutrition_database import nutrition_db

logger = logging.getLogger(__name__)


class OpenAIService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å OpenAI API"""
    
    def __init__(self):
        # –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å API –∫–ª—é—á
        if settings.openai_api_key:
            self.client = AsyncOpenAI(api_key=settings.openai_api_key)
        else:
            self.client = None
    
    async def analyze_food_image(self, image_data: bytes) -> Dict:
        """
        –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤.
        
        Args:
            image_data: –ë–∞–π—Ç—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            
        Returns:
            Dict —Å –∫–ª—é—á–∞–º–∏:
                - ingredients: —Å–ø–∏—Å–æ–∫ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
                - uncertainties: —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤, —Ç—Ä–µ–±—É—é—â–∏—Ö —É—Ç–æ—á–Ω–µ–Ω–∏—è
        """
        if not image_data:
            raise ValueError("image_data –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º")
        
        logger.info(f"–ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, —Ä–∞–∑–º–µ—Ä: {len(image_data)} –±–∞–π—Ç")
        # –ö–æ–¥–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ base64
        base64_image = base64.b64encode(image_data).decode('utf-8')
        logger.info(f"Base64 —Ä–∞–∑–º–µ—Ä: {len(base64_image)} —Å–∏–º–≤–æ–ª–æ–≤")
        
        prompt = """
        –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤. –û–ø—Ä–µ–¥–µ–ª–∏, —á—Ç–æ —Ç–∞–º –µ—Å—Ç—å.
        
        –í–µ—Ä–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ:
        {
            "ingredients": ["–ø—Ä–æ–¥—É–∫—Ç 1", "–ø—Ä–æ–¥—É–∫—Ç 2", ...],
            "uncertainties": [
                {
                    "item": "–æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≥–æ, —á—Ç–æ –≤–∏–¥–Ω–æ",
                    "options": ["–≤–∞—Ä–∏–∞–Ω—Ç 1", "–≤–∞—Ä–∏–∞–Ω—Ç 2"]
                }
            ]
        }
        
        –í "uncertainties" –ø–æ–º–µ—â–∞–π –ø—Ä–æ–¥—É–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —Å–ª–æ–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–æ—á–Ω–æ 
        (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ - —ç—Ç–æ –≤–µ—Ç—á–∏–Ω–∞ –∏–ª–∏ –∫–æ–ª–±–∞—Å–∞, –∫—É—Ä–∏—Ü–∞ –∏–ª–∏ –∏–Ω–¥–µ–π–∫–∞).
        
        –ë—É–¥—å —Ç–æ—á–Ω—ã–º –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤.
        """
        
        if not self.client:
            raise Exception("OpenAI –∫–ª–∏–µ–Ω—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ API –∫–ª—é—á–∞.")
        
        try:
            logger.info("–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ OpenAI –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è")
            response = await self.client.chat.completions.create(
                model="gpt-4o",  # –ú–æ–¥–µ–ª—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                messages=[
                    {
                        "role": "user",
                        "content": [
                            {"type": "text", "text": prompt},
                            {
                                "type": "image_url",
                                "image_url": {
                                    "url": f"data:image/jpeg;base64,{base64_image}"
                                }
                            }
                        ]
                    }
                ],
                response_format={"type": "json_object"},
                max_tokens=1000,
                timeout=30.0  # –¢–∞–π–º–∞—É—Ç 30 —Å–µ–∫—É–Ω–¥
            )
            
            result = json.loads(response.choices[0].message.content)
            return result
        except Exception as e:
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ OpenAI API
            error_msg = str(e)
            if "rate_limit" in error_msg.lower():
                raise Exception("–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ OpenAI. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.")
            elif "timeout" in error_msg.lower():
                raise Exception("–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç OpenAI. –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑.")
            elif "invalid_api_key" in error_msg.lower() or "authentication" in error_msg.lower():
                raise Exception("–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ OpenAI API. –ü—Ä–æ–≤–µ—Ä—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.")
            else:
                raise Exception(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ OpenAI: {error_msg}")
    
    async def generate_recipe(
        self,
        target_calories: int,
        image_data: Optional[bytes] = None,
        ingredients: Optional[List[str]] = None,
        target_protein: Optional[float] = None,
        target_fat: Optional[float] = None,
        target_carbs: Optional[float] = None,
        plant_level: Optional[float] = None,
        cooking_tags: Optional[str] = None
    ) -> Dict:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ä–µ—Ü–µ–ø—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–æ—Ç–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏ —Ü–µ–ª–µ–≤—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –ö–ë–ñ–£.
        
        Args:
            target_calories: –¶–µ–ª–µ–≤—ã–µ –∫–∞–ª–æ—Ä–∏–∏ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
            image_data: –ë–∞–π—Ç—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
            ingredients: –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –Ω–µ—Ç —Ñ–æ—Ç–æ)
            target_protein: –¶–µ–ª–µ–≤–æ–π –±–µ–ª–æ–∫ (–≥, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            target_fat: –¶–µ–ª–µ–≤—ã–µ –∂–∏—Ä—ã (–≥, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            target_carbs: –¶–µ–ª–µ–≤—ã–µ —É–≥–ª–µ–≤–æ–¥—ã (–≥, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            plant_level: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ –∏–ª–∏ —É—Ä–æ–≤–µ–Ω—å "–±–æ–ª—å—à–µ –æ–≤–æ—â–µ–π" (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            cooking_tags: –¢–µ–≥–∏ —Å–ø–æ—Å–æ–±–æ–≤ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            
        Returns:
            Dict —Å –∫–ª—é—á–∞–º–∏:
                - recipe_title: –ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞
                - why_good: –ü–æ—á–µ–º—É —ç—Ç–æ —Ö–æ—Ä–æ—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç
                - ingredients: –°–ø–∏—Å–æ–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ —Å –≤–µ—Å–∞–º–∏
                - cooking_steps: –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
                - calculated_nutrition: –†–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–æ–µ –ö–ë–ñ–£
                - image_prompt: –ü—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥–æ—Ç–æ–≤–æ–≥–æ –±–ª—é–¥–∞
        """
        
        # –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
        if image_data:
            system_prompt = """–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —à–µ—Ñ-–ø–æ–≤–∞—Ä –∏ –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥.
–¢—ã –≥–æ—Ç–æ–≤–∏—à—å **—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ, –≤–∫—É—Å–Ω—ã–µ –∏ –≤—ã–ø–æ–ª–Ω–∏–º—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã**, –±–µ–∑ —Ñ–∞–Ω—Ç–∞–∑–∏–π –∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –Ω–∞ —Ñ–æ—Ç–æ.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–æ–∑–¥–∞—Ç—å **–æ–¥–∏–Ω –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –ø—Ä–∏–µ–º –ø–∏—â–∏**, –∞ –Ω–µ –ø–æ–¥–±–æ—Ä–∫—É –∏–¥–µ–π.

–¢—ã:
* –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –Ω–∞ —Ñ–æ—Ç–æ
* –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–µ—à—å —Å–ø–µ—Ü–∏–∏, –º–∞—Å–ª–∞, —Å–æ—É—Å—ã, –µ—Å–ª–∏ –∏—Ö –Ω–µ –≤–∏–¥–Ω–æ
* –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—à—å —É–∫–∞–∑–∞–Ω–Ω—ã–µ –∫–∞–ª–æ—Ä–∏–∏
* –ø–∏—à–µ—à—å –∂–∏–≤–æ, —É–≤–µ—Ä–µ–Ω–Ω–æ, –ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏
* –æ–±—ä—è—Å–Ω—è–µ—à—å, –∑–∞—á–µ–º —ç—Ç–æ—Ç —Ä–µ—Ü–µ–ø—Ç —Ö–æ—Ä–æ—à–∏–π"""
        else:
            system_prompt = """–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —à–µ—Ñ-–ø–æ–≤–∞—Ä –∏ –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥.
–¢—ã –≥–æ—Ç–æ–≤–∏—à—å **—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ, –≤–∫—É—Å–Ω—ã–µ –∏ –≤—ã–ø–æ–ª–Ω–∏–º—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã** –∏–∑ —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–æ–∑–¥–∞—Ç—å **–æ–¥–∏–Ω –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –ø—Ä–∏–µ–º –ø–∏—â–∏**, –∞ –Ω–µ –ø–æ–¥–±–æ—Ä–∫—É –∏–¥–µ–π.

–¢—ã:
* –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –¢–û–õ–¨–ö–û —É–∫–∞–∑–∞–Ω–Ω—ã–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã
* –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–µ—à—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ
* –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—à—å —É–∫–∞–∑–∞–Ω–Ω—ã–µ –∫–∞–ª–æ—Ä–∏–∏
* –ø–∏—à–µ—à—å –∂–∏–≤–æ, —É–≤–µ—Ä–µ–Ω–Ω–æ, –ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏
* –æ–±—ä—è—Å–Ω—è–µ—à—å, –∑–∞—á–µ–º —ç—Ç–æ—Ç —Ä–µ—Ü–µ–ø—Ç —Ö–æ—Ä–æ—à–∏–π"""
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç
        user_prompt_parts = []
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ü–µ–ª–µ–≤—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è—Ö
        user_prompt_parts.append(f"–¶–µ–ª–µ–≤–∞—è –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å –±–ª—é–¥–∞: {target_calories} –∫–∫–∞–ª")
        
        if target_protein is not None and target_protein > 0:
            user_prompt_parts.append(f"–ë–µ–ª–∫–∏: {target_protein} –≥")
        else:
            user_prompt_parts.append("–ë–µ–ª–∫–∏: null")
        
        if target_fat is not None and target_fat > 0:
            user_prompt_parts.append(f"–ñ–∏—Ä—ã: {target_fat} –≥")
        else:
            user_prompt_parts.append("–ñ–∏—Ä—ã: null")
        
        if target_carbs is not None and target_carbs > 0:
            user_prompt_parts.append(f"–£–≥–ª–µ–≤–æ–¥—ã: {target_carbs} –≥")
        else:
            user_prompt_parts.append("–£–≥–ª–µ–≤–æ–¥—ã: null")
        
        if plant_level is not None and plant_level > 0:
            user_prompt_parts.append(f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ –∏–ª–∏ —É—Ä–æ–≤–µ–Ω—å '–±–æ–ª—å—à–µ –æ–≤–æ—â–µ–π': {plant_level}")
        
        user_prompt_base = "\n".join(user_prompt_parts)
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–º–ø—Ç
        if image_data:
            ingredients_instruction = "–°–ø–∏—Å–æ–∫ —Ç–æ–ª—å–∫–æ –∏–∑ —Ç–æ–≥–æ, —á—Ç–æ –≤–∏–¥–Ω–æ –Ω–∞ —Ñ–æ—Ç–æ."
            limitations_note = "–ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ –ë–ñ–£ –Ω–µ—Ç ‚Äî –æ—Ä–∏–µ–Ω—Ç–∏—Ä—É–π—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –∫–∞–ª–æ—Ä–∏–∏ –∏ —Ñ–æ—Ç–æ."
        else:
            ingredients_instruction = "–°–ø–∏—Å–æ–∫ —Ç–æ–ª—å–∫–æ –∏–∑ —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤."
            limitations_note = "–ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ –ë–ñ–£ –Ω–µ—Ç ‚Äî –æ—Ä–∏–µ–Ω—Ç–∏—Ä—É–π—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –∫–∞–ª–æ—Ä–∏–∏ –∏ —Å–ø–∏—Å–æ–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤."
        
        main_prompt = f"""
#### –¢–≤–æ—è –∑–∞–¥–∞—á–∞:

1. –û–ø—Ä–µ–¥–µ–ª–∏, **–∫–∞–∫–æ–µ –æ–¥–Ω–æ –±–ª—é–¥–æ** –ª–æ–≥–∏—á–Ω–æ –ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
2. –°–æ—Å—Ç–∞–≤—å **–æ–¥–∏–Ω —Ä–µ—Ü–µ–ø—Ç**, –∫–æ—Ç–æ—Ä—ã–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –±–ª–∏–∑–æ–∫ –∫ –∑–∞–¥–∞–Ω–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º
3. –°–¥–µ–ª–∞–π —Ä–µ—Ü–µ–ø—Ç:
   * —Å—ã—Ç–Ω—ã–º
   * –ø—Ä–æ—Å—Ç—ã–º
   * —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º –¥–ª—è –æ–±—ã—á–Ω–æ–π –∫—É—Ö–Ω–∏
4. –ù–µ –ø—ã—Ç–∞–π—Å—è –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–ø–∞—Å—Ç—å –≤ –ö–ë–ñ–£, –¥–æ–ø—É—Å—Ç–∏–º–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ ¬±10%

---

### –§–û–†–ú–ê–¢ –í–´–•–û–î–ê (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)

#### –ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞

–ö–æ—Ä–æ—Ç–∫–æ–µ, –∞–ø–ø–µ—Ç–∏—Ç–Ω–æ–µ, –±–µ–∑ –ø–∞—Ñ–æ—Å–∞.

#### –ü–æ—á–µ–º—É —ç—Ç–æ —Ö–æ—Ä–æ—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç

2‚Äì3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è. –ü—Ä–æ —Å—ã—Ç–æ—Å—Ç—å, –±–∞–ª–∞–Ω—Å, —Å–∫–æ—Ä–æ—Å—Ç—å –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è.

#### –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã

{ingredients_instruction}
–° –ø—Ä–∏–º–µ—Ä–Ω—ã–º –≤–µ—Å–æ–º –∏–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º.

#### –ö–∞–∫ –≥–æ—Ç–æ–≤–∏—Ç—å

–ü–æ—à–∞–≥–æ–≤–æ.
–ö–æ—Ä–æ—Ç–∫–∏–µ —à–∞–≥–∏.
–ë–µ–∑ –≤–æ–¥—ã.
–ë–µ–∑ ¬´–ø–æ –∂–µ–ª–∞–Ω–∏—é¬ª.

#### –ö–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å –∏ –º–∞–∫—Ä–æ—Å—ã

–ü—Ä–∏–º–µ—Ä–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:
* –ö–∞–ª–æ—Ä–∏–∏
* –ë–µ–ª–∫–∏
* –ñ–∏—Ä—ã
* –£–≥–ª–µ–≤–æ–¥—ã

---

### –ì–ï–ù–ï–†–ê–¶–ò–Ø –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø (–û–¢–î–ï–õ–¨–ù–´–ô –ë–õ–û–ö)

–ü–æ—Å–ª–µ —Ä–µ—Ü–µ–ø—Ç–∞ **–æ—Ç–¥–µ–ª—å–Ω–æ** —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π prompt –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥–æ—Ç–æ–≤–æ–≥–æ –±–ª—é–¥–∞.

–§–æ—Ä–º–∞—Ç –ø—Ä–æ–º—Ç–∞ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:

–§–æ—Ç–æ—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è —Å—ä–µ–º–∫–∞ –≥–æ—Ç–æ–≤–æ–≥–æ –±–ª—é–¥–∞:
* —Ç–∏–ø –±–ª—é–¥–∞ –∏ –∫–ª—é—á–µ–≤—ã–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã
* –ø–æ–¥–∞—á–∞ –∫–∞–∫ –≤ —Ö–æ—Ä–æ—à–µ–º –∫–∞—Ñ–µ
* –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã–π —Å–≤–µ—Ç
* –≤–∏–¥ —Å–≤–µ—Ä—Ö—É –∏–ª–∏ 45 –≥—Ä–∞–¥—É—Å–æ–≤
* –≤—ã—Å–æ–∫–∞—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç—É—Ä
* –∞–ø–ø–µ—Ç–∏—Ç–Ω—ã–π, "—Ö–æ—á–µ—Ç—Å—è —Å—ä–µ—Å—Ç—å" –≤–∏–¥
* –±–µ–∑ –ª—é–¥–µ–π, –±–µ–∑ —Ç–µ–∫—Å—Ç–∞, –±–µ–∑ –ª–æ–≥–æ—Ç–∏–ø–æ–≤

---

### –í–ê–ñ–ù–´–ï –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø

* –û–¥–∏–Ω —Ä–µ—Ü–µ–ø—Ç. –ù–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ.
* –ù–∏–∫–∞–∫–∏—Ö —Å–æ–≤–µ—Ç–æ–≤ "–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å".
* –ù–∏–∫–∞–∫–∏—Ö –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–π.
* {limitations_note}
* –ï—Å–ª–∏ –∫–∞–ª–æ—Ä–∏–∏ –Ω–µ—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã –¥–ª—è –Ω–∞–±–æ—Ä–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ ‚Äî —á–µ—Å—Ç–Ω–æ –∞–¥–∞–ø—Ç–∏—Ä—É–π –ø–æ—Ä—Ü–∏–∏.

–í–µ—Ä–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ:
{{
    "recipe_title": "–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞",
    "why_good": "2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ —Ç–æ–º, –ø–æ—á–µ–º—É —ç—Ç–æ —Ö–æ—Ä–æ—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç",
    "ingredients": [
        {{"name": "–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç", "weight_g": 100, "note": "–ø—Ä–∏–º–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ"}}
    ],
    "cooking_steps": [
        "–®–∞–≥ 1",
        "–®–∞–≥ 2"
    ],
    "calculated_nutrition": {{
        "calories": 500.0,
        "protein_g": 30.0,
        "fat_g": 20.0,
        "carbs_g": 40.0
    }},
    "image_prompt": "–î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥–æ—Ç–æ–≤–æ–≥–æ –±–ª—é–¥–∞"
}}
"""
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è API
        messages = [
            {
                "role": "system",
                "content": system_prompt
            }
        ]
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        user_content = []
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—É—é —á–∞—Å—Ç—å –ø—Ä–æ–º–ø—Ç–∞
        text_content = f"{user_prompt_base}\n\n{main_prompt}"
        
        # –ï—Å–ª–∏ –µ—Å—Ç—å —Å–ø–∏—Å–æ–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
        if ingredients and not image_data:
            ingredients_text = ", ".join(ingredients)
            text_content = f"–î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã: {ingredients_text}\n\n{text_content}"
        
        user_content.append({"type": "text", "text": text_content})
        
        # –ï—Å–ª–∏ –µ—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ
        if image_data:
            logger.info(f"–ü–µ—Ä–µ–¥–∞—á–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ OpenAI, —Ä–∞–∑–º–µ—Ä: {len(image_data)} –±–∞–π—Ç")
            base64_image = base64.b64encode(image_data).decode('utf-8')
            logger.info(f"Base64 —Ä–∞–∑–º–µ—Ä: {len(base64_image)} —Å–∏–º–≤–æ–ª–æ–≤")
            user_content.append({
                "type": "image_url",
                "image_url": {
                    "url": f"data:image/jpeg;base64,{base64_image}"
                }
            })
            logger.info("–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∑–∞–ø—Ä–æ—Å –∫ OpenAI")
        else:
            logger.warning("–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–æ –≤ generate_recipe (image_data is None)")
        
        messages.append({
            "role": "user",
            "content": user_content
        })
        
        if not self.client:
            raise Exception("OpenAI –∫–ª–∏–µ–Ω—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ API –∫–ª—é—á–∞.")
        
        try:
            logger.info(f"–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ OpenAI –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ—Ü–µ–ø—Ç–∞. –ü–µ—Ä–µ–¥–∞–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: {image_data is not None}")
            response = await self.client.chat.completions.create(
                model="gpt-4o",
                messages=messages,
                response_format={"type": "json_object"},
                temperature=0.7,
                max_tokens=2500,
                timeout=60.0
            )
            
            result = json.loads(response.choices[0].message.content)
            
            # –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ–º –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: –¥–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –ø–æ–ª—è, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
            if "ingredients_with_weights" not in result and "ingredients" in result:
                result["ingredients_with_weights"] = result["ingredients"]
            
            return result
        except Exception as e:
            error_msg = str(e)
            if "rate_limit" in error_msg.lower():
                raise Exception("–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ OpenAI. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.")
            elif "timeout" in error_msg.lower():
                raise Exception("–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç OpenAI. –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑.")
            else:
                raise Exception(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ—Ü–µ–ø—Ç–∞: {error_msg}")
    
    @staticmethod
    def format_recipe_response(recipe_data: Dict) -> str:
        """
        –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç–∞ –≤ –∫—Ä–∞—Å–∏–≤—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
        
        Args:
            recipe_data: –î–∞–Ω–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç–∞ –∏–∑ generate_recipe
            
        Returns:
            –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç —Ä–µ—Ü–µ–ø—Ç–∞
        """
        lines = []
        lines.append(f"üçΩ *{recipe_data['recipe_title']}*\n")
        
        # –î–æ–±–∞–≤–ª—è–µ–º "–ü–æ—á–µ–º—É —ç—Ç–æ —Ö–æ—Ä–æ—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç", –µ—Å–ª–∏ –µ—Å—Ç—å
        if 'why_good' in recipe_data:
            lines.append(f"üí° *–ü–æ—á–µ–º—É —ç—Ç–æ —Ö–æ—Ä–æ—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç:*\n{recipe_data['why_good']}\n")
        
        lines.append("üìã *–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:*")
        # –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞: ingredients –∏ ingredients_with_weights
        ingredients_list = recipe_data.get('ingredients', recipe_data.get('ingredients_with_weights', []))
        for ing in ingredients_list:
            name = ing.get('name', '')
            weight = ing.get('weight_g', '')
            note = ing.get('note', '')
            if weight:
                line = f"‚Ä¢ {name}: {weight} –≥"
                if note:
                    line += f" ({note})"
                lines.append(line)
            else:
                lines.append(f"‚Ä¢ {name}")
        
        lines.append("\nüë®‚Äçüç≥ *–ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ:*")
        cooking_steps = recipe_data.get('cooking_steps', [])
        for i, step in enumerate(cooking_steps, 1):
            lines.append(f"{i}. {step}")
        
        nutrition = recipe_data.get('calculated_nutrition', {})
        if nutrition:
            lines.append("\nüìä *–ö–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å –∏ –º–∞–∫—Ä–æ—Å—ã:*")
            lines.append(f"üî• –ö–∞–ª–æ—Ä–∏–∏: {nutrition.get('calories', 0):.0f} –∫–∫–∞–ª")
            if 'protein_g' in nutrition:
                lines.append(f"ü•© –ë–µ–ª–∫–∏: {nutrition['protein_g']:.1f} –≥")
            if 'fat_g' in nutrition:
                lines.append(f"üßà –ñ–∏—Ä—ã: {nutrition['fat_g']:.1f} –≥")
            if 'carbs_g' in nutrition:
                lines.append(f"üçû –£–≥–ª–µ–≤–æ–¥—ã: {nutrition['carbs_g']:.1f} –≥")
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –µ—Å–ª–∏ –µ—Å—Ç—å
        if 'image_prompt' in recipe_data:
            lines.append(f"\nüé® *–ü—Ä–æ–º–ø—Ç –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:*\n{recipe_data['image_prompt']}")
        
        return "\n".join(lines)
    
    async def generate_meal_plan(
        self,
        ingredients: List[str],
        meals_count: int,
        target_daily_calories: int,
        target_daily_protein: float,
        target_daily_fat: float,
        target_daily_carbs: float,
        daily_greens_weight: float
    ) -> Dict:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ä–∞—Ü–∏–æ–Ω –ø–∏—Ç–∞–Ω–∏—è –Ω–∞ –¥–µ–Ω—å —Å —Ç–æ—á–Ω—ã–º–∏ —Ä–∞—Å—á–µ—Ç–∞–º–∏ –ö–ë–ñ–£.
        
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–≤—É—Ö—ç—Ç–∞–ø–Ω—ã–π –ø–æ–¥—Ö–æ–¥:
        1. GPT –≤—ã–±–∏—Ä–∞–µ—Ç –ø—Ä–æ–¥—É–∫—Ç—ã –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∏—Ö –ø–æ –ø—Ä–∏–µ–º–∞–º –ø–∏—â–∏
        2. Python —Ç–æ—á–Ω–æ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –ö–ë–ñ–£ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        """
        
        ingredients_text = ", ".join(ingredients)
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–∏–µ–º–æ–≤ –ø–∏—â–∏
        meal_names = {
            1: ["–ü—Ä–∏–µ–º –ø–∏—â–∏"],
            2: ["–ü–µ—Ä–≤—ã–π –ø—Ä–∏–µ–º", "–í—Ç–æ—Ä–æ–π –ø—Ä–∏–µ–º"],
            3: ["–ó–∞–≤—Ç—Ä–∞–∫", "–û–±–µ–¥", "–£–∂–∏–Ω"],
            4: ["–ó–∞–≤—Ç—Ä–∞–∫", "–û–±–µ–¥", "–ü–æ–ª–¥–Ω–∏–∫", "–£–∂–∏–Ω"],
            5: ["–ó–∞–≤—Ç—Ä–∞–∫", "–í—Ç–æ—Ä–æ–π –∑–∞–≤—Ç—Ä–∞–∫", "–û–±–µ–¥", "–ü–æ–ª–¥–Ω–∏–∫", "–£–∂–∏–Ω"],
            6: ["–ó–∞–≤—Ç—Ä–∞–∫", "–í—Ç–æ—Ä–æ–π –∑–∞–≤—Ç—Ä–∞–∫", "–û–±–µ–¥", "–ü–æ–ª–¥–Ω–∏–∫", "–£–∂–∏–Ω", "–ü–æ–∑–¥–Ω–∏–π —É–∂–∏–Ω"]
        }
        
        meals_names_list = meal_names.get(meals_count, [f"–ü—Ä–∏–µ–º {i+1}" for i in range(meals_count)])
        
        # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        available_products_in_db = list(nutrition_db.PRODUCTS.keys())
        
        # –ü—ã—Ç–∞–µ–º—Å—è —Å–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
        matched_products = []
        for ingredient in ingredients:
            ingredient_lower = ingredient.lower()
            # –ò—â–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
            found = False
            for db_product in available_products_in_db:
                if ingredient_lower in db_product or db_product in ingredient_lower:
                    matched_products.append(db_product)
                    found = True
                    break
            if not found:
                # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å (–±—É–¥–µ–º –∏—Å–∫–∞—Ç—å –ø–æ–∑–∂–µ)
                matched_products.append(ingredient)
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞
        products_for_prompt = list(set(matched_products))  # –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
        products_text = ", ".join([f'"{p}"' for p in products_for_prompt])
        
        # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–µ–º–∞ –ø–∏—â–∏
        meal_rules_text = ""
        for meal_name in meals_names_list:
            rules = nutrition_db.get_meal_rules(meal_name)
            if rules:
                meal_rules_text += f"\n{meal_name}: {rules['description']}\n"
                meal_rules_text += f"  –ü—Ä–∏–º–µ—Ä—ã: {'; '.join(rules['examples'])}\n"
        
        prompt = f"""
        –¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –¥–∏–µ—Ç–æ–ª–æ–≥. –°–æ—Å—Ç–∞–≤—å –°–ë–ê–õ–ê–ù–°–ò–†–û–í–ê–ù–ù–´–ô —Ä–∞—Ü–∏–æ–Ω –ø–∏—Ç–∞–Ω–∏—è –Ω–∞ –¥–µ–Ω—å.
        
        –î–û–°–¢–£–ü–ù–´–ï –ü–†–û–î–£–ö–¢–´ (–∏—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —ç—Ç–∏ –Ω–∞–∑–≤–∞–Ω–∏—è!):
        {products_text}
        
        –¶–µ–ª–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –ó–ê –í–ï–°–¨ –î–ï–ù–¨:
        - –ö–∞–ª–æ—Ä–∏–∏: {target_daily_calories} –∫–∫–∞–ª
        - –ë–µ–ª–∫–∏: {target_daily_protein} –≥
        - –ñ–∏—Ä—ã: {target_daily_fat} –≥
        - –£–≥–ª–µ–≤–æ–¥—ã: {target_daily_carbs} –≥
        - –û–≤–æ—â–∏/—Ñ—Ä—É–∫—Ç—ã: {daily_greens_weight} –≥
        
        –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∏–µ–º–æ–≤ –ø–∏—â–∏: {meals_count} ({', '.join(meals_names_list)})
        
        –ü–†–ê–í–ò–õ–ê –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–µ–º–∞ –ø–∏—â–∏:
        {meal_rules_text}
        
        –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
        0. –ò–°–ü–û–õ–¨–ó–£–ô –¢–û–õ–¨–ö–û –¢–û–ß–ù–´–ï –ù–ê–ó–í–ê–ù–ò–Ø –ü–†–û–î–£–ö–¢–û–í –ò–ó –°–ü–ò–°–ö–ê –í–´–®–ï!
           ‚ùå –ù–ï–õ–¨–ó–Ø –ø–∏—Å–∞—Ç—å: "–∂–∞—Ä–µ–Ω–∞—è –∫—É—Ä–∏—Ü–∞", "—Å–∞–ª–∞—Ç —Å –æ–≤–æ—â–∞–º–∏", "–∂—ë–ª—Ç—ã–π –ø–µ—Ä–µ—Ü"
           ‚úÖ –ú–û–ñ–ù–û –ø–∏—Å–∞—Ç—å —Ç–æ–ª—å–∫–æ: "–∫—É—Ä–∏—Ü–∞ –≥—Ä—É–¥–∫–∞", "–ø–æ–º–∏–¥–æ—Ä—ã", "–ø–µ—Ä–µ—Ü –±–æ–ª–≥–∞—Ä—Å–∫–∏–π"
        
        1. –ó–∞–≤—Ç—Ä–∞–∫: –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –±–µ–ª–æ–∫ + —Å–ª–æ–∂–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã (–∫–∞—à–∞/—Ö–ª–µ–±) + –æ–≤–æ—â–∏
           ‚ùå –ù–ï–õ–¨–ó–Ø: —Ç–æ–ª—å–∫–æ —è–π—Ü–∞ –∏ —Å–∞–ª–∞—Ç, —è–π—Ü–∞ —Å —Ñ—Ä—É–∫—Ç–∞–º–∏ –±–µ–∑ –∫–∞—à–∏
           ‚úÖ –ú–û–ñ–ù–û: —è–π—Ü–∞ + –æ–≤—Å—è–Ω–∫–∞ + –æ–≥—É—Ä—Ü—ã, —Ç–≤–æ—Ä–æ–≥ + —Ö–ª–µ–± + –ø–æ–º–∏–¥–æ—Ä—ã
        
        2. –û–±–µ–¥: –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –±–µ–ª–æ–∫ + –≥–∞—Ä–Ω–∏—Ä (—Ä–∏—Å/–≥—Ä–µ—á–∫–∞/–º–∞–∫–∞—Ä–æ–Ω—ã) + –æ–≤–æ—â–Ω–æ–π —Å–∞–ª–∞—Ç
           ‚ùå –ù–ï–õ–¨–ó–Ø: —Ç–æ–ª—å–∫–æ –º—è—Å–æ —Å –æ–≤–æ—â–∞–º–∏ –±–µ–∑ –≥–∞—Ä–Ω–∏—Ä–∞
           ‚úÖ –ú–û–ñ–ù–û: –∫—É—Ä–∏—Ü–∞ + —Ä–∏—Å + —Å–∞–ª–∞—Ç –∏–∑ –æ–≤–æ—â–µ–π
        
        3. –£–∂–∏–Ω: –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –±–µ–ª–æ–∫ + –º–Ω–æ–≥–æ –æ–≤–æ—â–µ–π, –ú–ò–ù–ò–ú–£–ú —É–≥–ª–µ–≤–æ–¥–æ–≤
           ‚ùå –ù–ï–õ–¨–ó–Ø: —Ñ—Ä—É–∫—Ç—ã, —Å–ª–∞–¥–∫–æ–µ, –º–Ω–æ–≥–æ –∫–∞—à–∏
           ‚úÖ –ú–û–ñ–ù–û: —Ä—ã–±–∞ + —Ç—É—à–µ–Ω—ã–µ –æ–≤–æ—â–∏, —Ç–≤–æ—Ä–æ–≥ + –æ–≥—É—Ä—Ü—ã
        
        4. –°–æ—á–µ—Ç–∞–π –ø—Ä–æ–¥—É–∫—Ç—ã –õ–û–ì–ò–ß–ù–û (–∫–∞–∫ –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ):
           ‚ùå –ù–ï–õ–¨–ó–Ø: —è–π—Ü–∞ + –º–∞–ª–∏–Ω–∞, –∞—Ä–±—É–∑ + –ª—É–∫ + —á–µ—Ä–Ω–∏–∫–∞, –∫—É—Ä–∏—Ü–∞ + –∞–Ω–∞–Ω–∞—Å
           ‚úÖ –ú–û–ñ–ù–û: —è–π—Ü–∞ + –æ–≥—É—Ä—Ü—ã + —Ö–ª–µ–±, —Å–∞–ª–∞—Ç –∏–∑ –æ–≥—É—Ä—Ü–æ–≤ –∏ –ø–æ–º–∏–¥–æ—Ä–æ–≤
        
        5. –†–∞—Å–ø—Ä–µ–¥–µ–ª–∏ –∫–∞–ª–æ—Ä–∏–∏ –≥—Ä–∞–º–æ—Ç–Ω–æ:
           - –ó–∞–≤—Ç—Ä–∞–∫: 25-30% –æ—Ç –¥–Ω–µ–≤–Ω–æ–π –Ω–æ—Ä–º—ã
           - –û–±–µ–¥: 35-40% –æ—Ç –¥–Ω–µ–≤–Ω–æ–π –Ω–æ—Ä–º—ã
           - –£–∂–∏–Ω: 20-25% –æ—Ç –¥–Ω–µ–≤–Ω–æ–π –Ω–æ—Ä–º—ã
           - –ü–µ—Ä–µ–∫—É—Å—ã: 5-10% –∫–∞–∂–¥—ã–π
        
        6. –ù–ê–ó–í–ê–ù–ò–Ø –ü–†–û–î–£–ö–¢–û–í:
           - –ö–æ–ø–∏—Ä—É–π –Ω–∞–∑–≤–∞–Ω–∏—è –¢–û–ß–ù–û –∏–∑ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
           - –ù–ï –¥–æ–±–∞–≤–ª—è–π —Å–ª–æ–≤–∞ "–∂–∞—Ä–µ–Ω—ã–π", "–∑–∞–ø–µ—á–µ–Ω–Ω—ã–π", "—Å–∞–ª–∞—Ç –∏–∑"
           - –ù–ï –æ–±—ä–µ–¥–∏–Ω—è–π –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤ –æ–¥–∏–Ω (—Ç–∏–ø–∞ "—Å–∞–ª–∞—Ç —Å –æ–≤–æ—â–∞–º–∏")
           - –ö–∞–∂–¥—ã–π –ø—Ä–æ–¥—É–∫—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π!
        
        –í–µ—Ä–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ JSON:
        {{
            "meals": [
                {{
                    "meal_name": "–ó–∞–≤—Ç—Ä–∞–∫",
                    "foods": [
                        {{"name": "—è–π—Ü–∞ –∫—É—Ä–∏–Ω—ã–µ", "weight_g": 100}},
                        {{"name": "–æ–≤—Å—è–Ω–∫–∞", "weight_g": 50}},
                        {{"name": "–æ–≥—É—Ä—Ü—ã", "weight_g": 100}}
                    ]
                }}
            ]
        }}
        
        –ë—É–¥—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–æ–º! –°–æ–∑–¥–∞–≤–∞–π –†–ï–ê–õ–¨–ù–´–ï —Å–æ—á–µ—Ç–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤, –∫–∞–∫ –≤ –Ω–∞—Å—Ç–æ—è—â–µ–º –º–µ–Ω—é!
        """
        
        try:
            response = await self.client.chat.completions.create(
                model="gpt-4o",
                messages=[
                    {
                        "role": "system",
                        "content": (
                            "–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –¥–∏–µ—Ç–æ–ª–æ–≥ —Å 15-–ª–µ—Ç–Ω–∏–º —Å—Ç–∞–∂–µ–º. "
                            "–¢—ã —Å–æ—Å—Ç–∞–≤–ª—è–µ—à—å —Ä–∞—Ü–∏–æ–Ω—ã –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö –ª—é–¥–µ–π. "
                            "–¢—ã –∑–Ω–∞–µ—à—å, –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–æ—á–µ—Ç–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã. "
                            "–¢—ã –ù–ò–ö–û–ì–î–ê –Ω–µ —Å–æ–∑–¥–∞—à—å –∞–±—Å—É—Ä–¥–Ω—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ —Ç–∏–ø–∞ '—è–π—Ü–∞ + –º–∞–ª–∏–Ω–∞' –∏–ª–∏ '–∞—Ä–±—É–∑ + –ª—É–∫'."
                        )
                    },
                    {
                        "role": "user",
                        "content": prompt
                    }
                ],
                response_format={"type": "json_object"},
                temperature=0.3,  # –°–Ω–∏–∑–∏–ª–∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –¥–ª—è –±–æ–ª–µ–µ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                max_tokens=2000,
                timeout=60.0  # –¢–∞–π–º–∞—É—Ç 60 —Å–µ–∫—É–Ω–¥
            )
            
            gpt_result = json.loads(response.choices[0].message.content)
        except Exception as e:
            error_msg = str(e)
            if "rate_limit" in error_msg.lower():
                raise Exception("–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ OpenAI. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.")
            elif "timeout" in error_msg.lower():
                raise Exception("–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç OpenAI. –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑.")
            else:
                raise Exception(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–ª–∞–Ω–∞ –ø–∏—Ç–∞–Ω–∏—è: {error_msg}")
        
        # –¢–µ–ø–µ—Ä—å –¢–û–ß–ù–û —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ö–ë–ñ–£ –∏–∑ –Ω–∞—à–µ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        meals_with_nutrition = []
        total_calories = 0
        total_protein = 0
        total_fat = 0
        total_carbs = 0
        
        for meal in gpt_result.get("meals", []):
            meal_calories = 0
            meal_protein = 0
            meal_fat = 0
            meal_carbs = 0
            
            foods_with_nutrition = []
            for food in meal.get("foods", []):
                product_name = food["name"]
                weight_g = food["weight_g"]
                
                # –ü–æ–ª—É—á–∞–µ–º —Ç–æ—á–Ω–æ–µ –ö–ë–ñ–£ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
                nutrition = nutrition_db.calculate_nutrition(product_name, weight_g)
                
                if nutrition:
                    meal_calories += nutrition["calories"]
                    meal_protein += nutrition["protein"]
                    meal_fat += nutrition["fat"]
                    meal_carbs += nutrition["carbs"]
                    
                    foods_with_nutrition.append({
                        "name": product_name,
                        "weight_g": weight_g
                    })
                else:
                    # –ï—Å–ª–∏ –ø—Ä–æ–¥—É–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ, –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –ø–æ—Ö–æ–∂–∏–µ
                    similar = nutrition_db.find_similar_products(product_name, limit=1)
                    if similar:
                        logger.warning(f"–ü—Ä–æ–¥—É–∫—Ç '{product_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º '{similar[0]}'")
                        nutrition = nutrition_db.calculate_nutrition(similar[0], weight_g)
                        if nutrition:
                            meal_calories += nutrition["calories"]
                            meal_protein += nutrition["protein"]
                            meal_fat += nutrition["fat"]
                            meal_carbs += nutrition["carbs"]
                            
                            foods_with_nutrition.append({
                                "name": similar[0],
                                "weight_g": weight_g
                            })
                        else:
                            logger.error(f"–ü—Ä–æ–¥—É–∫—Ç '{product_name}' –ø—Ä–æ–ø—É—â–µ–Ω (–Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ)")
                            foods_with_nutrition.append({
                                "name": product_name + " (–Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ë–î)",
                                "weight_g": weight_g
                            })
                    else:
                        logger.error(f"–ü—Ä–æ–¥—É–∫—Ç '{product_name}' –ø—Ä–æ–ø—É—â–µ–Ω (–Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ)")
                        foods_with_nutrition.append({
                            "name": product_name + " (–Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ë–î)",
                            "weight_g": weight_g
                        })
            
            total_calories += meal_calories
            total_protein += meal_protein
            total_fat += meal_fat
            total_carbs += meal_carbs
            
            meals_with_nutrition.append({
                "meal_name": meal["meal_name"],
                "foods": foods_with_nutrition,
                "nutrition": {
                    "calories": round(meal_calories, 1),
                    "protein_g": round(meal_protein, 1),
                    "fat_g": round(meal_fat, 1),
                    "carbs_g": round(meal_carbs, 1)
                }
            })
        
        return {
            "meals": meals_with_nutrition,
            "calculated_daily_nutrition": {
                "calories": round(total_calories, 1),
                "protein_g": round(total_protein, 1),
                "fat_g": round(total_fat, 1),
                "carbs_g": round(total_carbs, 1)
            }
        }
    
    @staticmethod
    def format_meal_plan_response(meal_plan_data: Dict) -> str:
        """
        –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ä–∞—Ü–∏–æ–Ω–∞ –≤ –∫—Ä–∞—Å–∏–≤—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
        
        Args:
            meal_plan_data: –î–∞–Ω–Ω—ã–µ —Ä–∞—Ü–∏–æ–Ω–∞ –∏–∑ generate_meal_plan
            
        Returns:
            –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç —Ä–∞—Ü–∏–æ–Ω–∞
        """
        lines = []
        lines.append("üìÖ *–†–∞—Ü–∏–æ–Ω –ø–∏—Ç–∞–Ω–∏—è –Ω–∞ –¥–µ–Ω—å*\n")
        
        for meal in meal_plan_data['meals']:
            lines.append(f"üçΩ *{meal['meal_name']}:*")
            for food in meal['foods']:
                lines.append(f"  ‚Ä¢ {food['name']} ‚Äî {food['weight_g']} –≥")
            
            # –ö–ë–ñ–£ –ø—Ä–∏–µ–º–∞ –ø–∏—â–∏
            nutrition = meal['nutrition']
            lines.append(
                f"  _–ö–ë–ñ–£: {nutrition['calories']:.0f} –∫–∫–∞–ª, "
                f"–ë: {nutrition['protein_g']:.1f}–≥, "
                f"–ñ: {nutrition['fat_g']:.1f}–≥, "
                f"–£: {nutrition['carbs_g']:.1f}–≥_\n"
            )
        
        # –ò—Ç–æ–≥–æ–≤–æ–µ –ö–ë–ñ–£ –∑–∞ –¥–µ–Ω—å
        daily_nutrition = meal_plan_data['calculated_daily_nutrition']
        lines.append("üìä *–ò—Ç–æ–≥–æ –∑–∞ –¥–µ–Ω—å:*")
        lines.append(f"üî• –ö–∞–ª–æ—Ä–∏–∏: {daily_nutrition['calories']:.0f} –∫–∫–∞–ª")
        lines.append(f"ü•© –ë–µ–ª–∫–∏: {daily_nutrition['protein_g']:.1f} –≥")
        lines.append(f"üßà –ñ–∏—Ä—ã: {daily_nutrition['fat_g']:.1f} –≥")
        lines.append(f"üçû –£–≥–ª–µ–≤–æ–¥—ã: {daily_nutrition['carbs_g']:.1f} –≥")
        
        return "\n".join(lines)


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–∏—Å–∞
openai_service = OpenAIService()

